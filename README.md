# FinGineers – HyperCLOVA Fin Agent

## 1. 프로젝트 개요
HyperCLOVA API와 yfinance 실시간·과거 데이터를 결합하여 **금융 Q&A**를 수행하는 에이전트입니다.  
데이터 풀: **(스팩, 리츠 제외 코스피 / 코스닥)**
- **신뢰성 & 속도**: 실시간/배치 파이프라인 + 한국거래소 영업일 캘린더 적용  
- **모듈식 아키텍처**: 자연어 질문 → HCX 파라미터화 → Router → Task Handler

## 2. 팀 정보

| 구분   | 내용                    |
| ------ | ---------------------- |
| **팀명** | FinGineers            |
| **분야** | AI Tech |
| **팀원** | 조용현 · 박선홍       |

## 3. API 사용법


### 요청 형식

- [HTTP Method & URL]
  ```
  GET /agent?question=질문내용
  ```
- **URL**
  ```
  http://49.50.131.34:8000/agent
  ```

**[필수 헤더]**

- Authorization: Bearer API_KEY 
- X-NCP-CLOVASTUDIO-REQUEST-ID: 세션 ID 

  (선택. 없으면 서버가 자동 생성, 멀티턴 문답 시 세션 ID 필요)

### 요청 예시 (Python)

```python
import requests

API_KEY = "nv-xxx..."
SESSION_ID = "23ef..."  # 첫 요청(멀티턴 X)은 생략 가능

response = requests.get(
    "http://49.50.131.34:8000/agent",
    params={"question": "2025년 6월 11일에 삼성전자의 종가는?"},
    headers={
        "Authorization": f"Bearer {API_KEY}",
        "X-NCP-CLOVASTUDIO-REQUEST-ID": SESSION_ID  # 첫 요청(멀티턴 X)은 생략 가능
    }
)

print(response.json())
```

### 응답 형식

```json
{
  "answer": "2025-06-11 기준 종가는 71,300원입니다.",
  "session_id": "abc123..."
}
```
멀티턴 질문으로 다음 HTTP request 시 전 request에서 response로 받은 Session ID를 다음 request 헤더의   X-NCP-CLOVASTUDIO-REQUEST-ID에 넣어야 함

### 에러 응답 예시

- 400: 질문이 비어 있음
- 401: API 키 누락 또는 형식 오류


## 4. 핵심 특징

### 4-1. yfinance 데이터 캐싱
* `app/yf_cache.py`  
  * **프리패치**: `2023-01-01 ~ 2025-07-31` 구간은 Parquet 캐시만 사용 → 네트워크 호출 *0*  
  * **미캐시 구간**은 yfinance 호출 후 응답. 해당 데이터는 캐싱하여 이후 질문에서 캐시된 데이터 사용 가능
  * 
* `scripts/prefetch_yf.py` CLI로 대량 사전 수집 및 레이트-리밋 자동 처리

### 4-2. Rate-Limit 대응 — `app/yf_cache.assure()`

  | 단계 | 로직 요약 |
  |------|-----------|
  | ① 캐시 미존재 티커 선별 | 입력 `tickers` 중 아직 캐시가 완전하지 않은 종목만 **todo** 리스트로 분리 |
  | ② 다중-티커 1차 다운로드 | `todo`를 `chunk`(기본 100) 단위로 잘라 `yfinance.download()` 병렬 호출 |
  | ③ 누락 티커 개별 조회 | batch 결과에 없던 티커는 `Ticker(t).history()`로 한 번 더 시도 |
  | ④ 오류 분류 | <br>• `YFRateLimitError` → **rate_limited** 집합에 추가, 다음 라운드 재시도<br>• `YFPricesMissingError‧YFTzMissingError` → 상장폐지/타임존 등 **permanent_fail** 목록에 기록 |
  | ⑤ 캐시 저장** | 정상 수신된 DF는 `save_or_append()`로 Parquet 병합 저장 |
  | ⑥ 지수(Exponential) 백오프 | 각 라운드 끝마다 `time.sleep(pause * 1.5^(attempt-1) + rand(0~1)s)` |
  | ⑦ 최대 `max_retry` 회 반복 | 기본 3회(`max_retry`)까지 ②-⑥ 루프, 끝나면 남은 rate-limited 티커 리스트를 반환 |
  | ⑧ 외부 확인용 속성 노출 | 함수 종료 시 `assure.rate_limited / error_log / permanent_fail` 속성에 결과 저장 |

### 4-3. 영업일 계산 & 휴장일 메시지
* `pandas_market_calendars`의 `XKRX` 달력 사용  
* 비영업일 질의 시 `_holiday_msg()`가  
  `YYYY-MM-DD는 휴장일입니다. 데이터가 없습니다.` 반환

## 5. Task 별 구현

### 5-1. Task 1 — 단순 조회

| 기능(메서드)                         | 설명                                    |
|--------------------------------------|-----------------------------------------|
| `가격·등락률` `_answer_price()`       | 시가·종가·고가·저가·등락률 계산         |
| `거래량 Top N` `_answer_volume()`     | 특정 날짜·시장별 거래량 상위 N           |
| `상승/하락 종목 수` `_answer_updown_count()` | 하루 기준 상승·하락·보합 종목 개수      |
| `거래대금 합계` `_answer_trading_value()` | 시장별·날짜별 거래대금 총합             |
| `Top Mover/Price` `_answer_top_mover()` 등 | 등락률·가격 상위/하위 N                |
| **다중 Ticker/Metric**                | “삼성전자·카카오 종가·거래량” 같은 복합 질의 지원 |
| **Look-back 7일**                     | 매매정지·데이터 누락 시 `_LOOKBACK_DAYS = 7` 범위에서 대체 |
| **Volume 0 필터**                     | 거래량 0 종목은 모든 랭킹·통계에서 제외  |
- **다중 Ticker/Metric 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답))
    ```text
    U: 2025-06-17 삼성전자, 카카오, 네이버의 종가, 거래량, 등락률, 변동성, 베타는?
    A: 2025-06-17 기준 종목별 지표는 다음과 같습니다.
      - 삼성전자: 종가 58,100원, 거래량 28,637,003주, 등락률 +1.57%, 변동성 0.320, 베타 7.67
      - 카카오: 종가 51,800원, 거래량 3,981,660주, 등락률 -2.63%, 변동성 0.551, 베타 22.30
      - 네이버: 종가 206,500원, 거래량 837,169주, 등락률 -1.43%, 변동성 0.317, 베타 26.87
    ```

---

### 5-2. Task 2 & Task 3 — 조건검색·시그널 감지

| 기능(메서드)                             | 설명                                                                 |
|------------------------------------------|----------------------------------------------------------------------|
| `종가 조건` `search_by_price_close()`     | 특정 날짜 기준 종가의 최소/최대 조건 필터링                         |
| `거래량 조건` `search_by_volume()`        | 특정 날짜 기준 거래량 최소/최대 조건 필터링                         |
| `등락률 조건` `search_by_pct_change()`    | 특정 날짜 기준 등락률(%) 최소/최대 조건 필터링                      |
| `전일대비 거래량 증가` `search_by_volume_pct()` | 거래량 전일 대비 증가율(%) 조건 필터링                              |
| `RSI 과매수/과매도` `detect_rsi()`        | 14일 RSI 기준 필터링    |
| `거래량 급증` `detect_volume_spike()`     | 과거 N일 평균 대비 급등한 종목 탐지 |
| `이동평균 돌파` `detect_ma_break()`         | 종가가 이동평균선에서 벗어난 종목 탐지 |
| `볼린저밴드 터치` `detect_bollinger_touch()` | 종가가 상단/하단 밴드에 접촉한 종목 탐지   |
| `기간 등락률 범위` `search_by_pct_change_range()` | 주어진 기간 동안 등락률 범위 내 종목 필터링                         |
| `연속 상승/하락` `search_by_consecutive_change()` | N일 연속 상승/하락한 종목 필터링                                   |
| `골든/데드크로스` `search_cross_dates_by_condition()` | 기간 중 단/장기 이평선의 골든/데드크로스 발생 종목 탐색            |
| `크로스 발생 횟수` `search_cross_count_by_stock()` | 특정 종목의 기간 내 크로스 발생 횟수 계산                          |

 #### **기본 설정값 적용**

  | 조건 유형          | 기본값                                      |
  |-------------------|---------------------------------------------|
  | RSI               | 기간: 14일, RSI 값 미설정 시 과매수=70, 과매도=30   |
  | 거래량 급증         | 기간: 20일             |
  | 이동평균 돌파       | 기간: 20일           |
  | 볼린저밴드 터치   | 기간: 20일, 편차: 2 |
---

- **다중 조건 AND 검색**  
  하나의 질문에 여러 조건이 포함될 경우, 해당 조건을 **모두 만족하는 종목만 반환**
  추가로 구현한 적/흑삼병, 신고/저가 등의 종목 질문도 다중 조건에 포함해서 질문 가능

- **거래량 0 제외**  
  거래량이 0인 종목은 **모든 조건 필터링 및 결과 출력에서 자동 제외**

- **기본 설정값 적용**

  | 조건 유형          | 기본값                                      |
  |-------------------|---------------------------------------------|
  | RSI               | 기간: 14일, 과매수=70, 과매도=30   |
  | 거래량 급증         | 기간: 20일             |
  | 이동평균 돌파       | 기간: 20일           |
  | 볼린저밴드 터치   | 기간: 20일, 편차: 2 |

- **다중 조건 검색 및 기본 설정값 적용 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답))
    ```text
    U: 2025년 5월 30일에 등락률이 +10% 이상인 과매수 종목 알려줘  
    A: 2025-05-30에 등락률이 10% 이상 상승인, RSI가 70 이상인 종목은 다음과 같습니다.
       DH오토리드, DH오토웨어, ... (이하 생략)
    ```
---


---

### 5-3. Task 4 — 모호한 의미 해석

- “최근 많이 오른 주식 알려줘” 같은 추상 질의를 **HCX 프롬프트 예시**로 Task 1–3 JSON 구조로 재해석 
  
  - **추상 질의 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답)) (질문일: 2025-07-31)
    ```text
      U: 최근 많이 오른 종목 알려줘
      A: 2025-07-31에 260일 내 신고가를 돌파한 종목은 다음과 같습니다.
         HD현대마린엔진, HD현대미포, ... (이하 생략)
      ```
--- 
- **날짜 키워드 자동 보정**  
  - `오늘·금일·당일` → 질의 당일  
  - `어제·전날·1일 전` → 질의 1일 전
  - `그제·전전날·2일 전` → 질의 2일 전  
  - `최근·요즘` → 질의 당일 기준 가장 최근 영업일  
  - `YYYY` 생략 시 `2025년`으로 자동 매핑
  - 다양한 포맷 (`YYYY/MM/DD`, `YYYY년 MM월 DD일`) 지원  
  
  - **날짜 키워드 자동 보정 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답)) (질문일: 2025-07-31)
    ```text
    U: 오늘 삼성전자 종가 알려줘
    A: 2025-07-31에 삼성전자의 종가은(는) 71,450원 입니다.

    U: 7월 22일 코스피 지수는?
    A: 2025-07-22에 KOSPI 지수는 3,169.94 입니다.
    ```
---
- 필수 슬롯 누락 시 **후속 재질문을 한국어로 자연스럽게 생성**

    - **재질문 대화 예시**
     `U:`는 사용자(질문), `A:`는 Fin Agent(응답)입니다.
    ```text
    ### 단순 조회 단일 필드 누락 재질문 ###
    U: 삼성전자 종가는?
    A: 어떤 날짜의 삼성전자 종가를 알려 드릴까요?
    U: 2025-07-07
    A: 2025-07-07에 삼성전자의 종가은(는) 61,700원 입니다.

    ### 단순 조회 다중 필드 누락 재질문 ###
    U: 종가, 거래량, 등락률은?
    A: 어떤 날짜에 어떤 종목의 종가 · 거래량 · 등락률을(를) 알려 드릴까요?
    U: 2025-07-07, 삼성전자
    A: 2025-07-07에 삼성전자의 종가 61,700원, 거래량 17,164,708주, 등락률 -2.53% 입니다.

    ### 조건 검색 필드 누락 재질문 ###
    U: 고점 대비 좀 많이 빠진 종목 알려줘
    A: 어떤 날짜에 260일 대비 몇% 이상 하락한 종목을 알려 드릴까요?
    U: 2025-06-17, 20%
    A: 2025-06-17에 260일 고점 대비 20% 이상 하락한 종목은 다음과 같습니다.
       AJ네트웍스, AK홀딩스, ... (이하 생략)
    ```
---
- **Ticker 디스앰비규에이션**

  | 단계 | 방법                     | 설명                                              |
  | ---- | ------------------------ | ------------------------------------------------- |
  | ①    | 정적 CSV                | KOSPI·KOSDAQ·Alias 매핑                           |
  | ②    | **Fuzzy**               | `rapidfuzz` 편집거리 → 상위 `TOP_K_FUZZY = 3`         |
  | ③    | **Sentence-BERT 임베딩**| 768-dim cosine sim → 상위 `TOP_K_EMBED = 3`           |
  | ④    | **HCX Re-ranking**      | 후보를 HyperCLOVA가 최종 선택 (conf ≥ 0.82)       |

  - 모호하면 `AmbiguousTickerError`를 발생시켜 **후속 재질문** 유도. Fuzzy와 Sentence-BERT 임베딩 상위 후보를 예시로 제안.

  - **Ticker 디스앰비규에이션 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답)) (질문일: 2025-07-31)
    ```text
    ### 별칭, 영어/한글, 오타 인식 ###
    U: 오늘 삼전, 엘지, kaka 종가는?
    A: 2025-07-31 기준 종목별 지표는 다음과 같습니다.
      - 삼성전자: 종가 71,550원
      - LG: 종가 79,500원
      - 카카오: 종가 56,700원
    
    ### 인식 실패 시 임베딩 상위 후보 제안 ###
    U: 오늘 가나다라마 종가는?
    A: 종목명 인식에 실패하였습니다: "가나다라마". 조회할 종목명을 정확하게 입력해 주세요 (제안: 나라셀라 · 깨끗한나라 · 나라엠앤디 · 코다코 · 코스나인 · 삼양사)
    U: 나라셀라
    A: 2025-07-31에 나라셀라의 종가은(는) 2,890원 입니다.
    ```

---

### 5-4. Task 5 — 고급 패턴·지표

| 카테고리               | 함수                         | 내용                                                          |
|------------------------|------------------------------|---------------------------------------------------------------|
| 캔들스틱 패턴          | `_scan_three_pattern()`      | 적삼병(Three White Soldiers), 흑삼병(Three Black Crows)       |
| 52주(n일) 신고가 돌파  | `detect_52w_high_break()`    | `period_days` 파라미터로 기간 가변                            |
| 52주(n일) 신저가       | `detect_52w_low()`           | —                                                             |
| 고점 대비 n % 하락     | `detect_off_peak()`          | 최고가 대비 하락률 필터                                       |
| 갭 상승·하락           | `search_by_gap_pct()`        | (Open_today − Close_prev) / Close_prev 기반                   |
| 급등·급락              | `search_by_pct_change()`     | 상·하한가, 근접, ±n % 등                                    |
| 변동률 (Volatility)    | `calculate_volatility()`     | 지정 기간(예: 20일) 동안 수익률의 표준편차(롤링 변동성) 계산  |
| 베타 (Beta)            | `calculate_beta()`           | 종목과 벤치마크(예: KOSPI) 간 상관계수로 산출된 베타 계수 계산 |

- **캔들스틱 패턴 대화 예시** (`U:`는 사용자(질문), `A:`는 Fin Agent(응답))

  ```text
  U: 2025/1/1부터 2025/1/31까지 적삼병이 발생한 종목은?
  A: 2025-01-01부터 2025-01-31까지 적삼병 패턴이 나타난 종목은 다음과 같습니다.
     KR모터스, 두산, ... (이하 생략)
  
  U: 2025-01-01부터 2025-01-31까지 삼성전자는 흑삼병이 몇 번 발생했어?
  A: 삼성전자 (2025-01-01~2025-01-31) black 발생 횟수는 4입니다.

  U: 2025-01-01부터 2025-01-31까지 삼성전자가 흑삼병이 발생한 날짜 알려줘
  A: 삼성전자 (2025-01-01~2025-01-31) black 발생일은 2025-01-13, 2025-01-14, 2025-01-15, 2025-01-20입니다.
  ```
- **52주(n일) 신고가/신저가 대화 예시**
  ```text
  U: 2025-06-05에 52주 신고가 돌파한 종목 알려줘
  A: 2025-06-05에 260일 내 신고가를 돌파한 종목은 다음과 같습니다.
     BYC우, CJ, ... (이하 생략)

  U: 2025-06-05에 최근 6개월 기준 52주 신고가를 넘어선 종목 알려줘
  A: 2025-06-05에 130일 내 신고가를 돌파한 종목은 다음과 같습니다.
     AK홀딩스, BGF에코머티리얼즈, ... (이하 생략)

  U: 2025-05-08에 최근 90일 최저가 찍은 코스닥 종목은?
  A: 2025-05-08에 90일 내 신저가를 갱신한 종목은 다음과 같습니다.
     AP헬스케어, 나우로보틱스, ... (이하 생략)
  ```

- **고점 대비 n% 하락 대화 예시**
  ```text
  U: 2025-02-03에 지난 100일 고점 대비 25% 이상 하락한 KOSPI 종목 알려줘
  A: 2025-02-03에 100일 고점 대비 25% 이상 하락한 종목은 다음과 같습니다.
     AK홀딩스, CJ씨푸드1우, ... (이하 생략)
  ```

- **갭 상승·하락 대화 예시**
  ```text
  U: 2025-06-30에 시가가 전일 종가 대비 5% 이상 갭상승한 종목 알려줘
  A: 2025-06-30에 갭상승 5% 이상 종목은 다음과 같습니다.
     SCL사이언스, SK이노베이션, ... (이하 생략)
  ```

- **급등·급락 대화 예시**
  ```text
  U: 2025-06-30 급등주 알려줘
  A: 2025-06-30에 등락률이 15% 이상 상승인 종목은 다음과 같습니다.
     FSN, SCL사이언스, ... (이하 생략)

  U: 2025-06-17에 상한가인 종목 알려줘
  A: 2025-06-17에 등락률이 30% 이상 상승인 종목은 다음과 같습니다.
     뱅크웨어글로벌, 신풍제약우
  
  U: 2025-06-17에 떡락한 종목 알려줘
  A: 2025-06-17에 등락률이 -15% 이하 하락인 종목은 다음과 같습니다.
     넥스트칩
  ```

- **변동성, 베타 대화 예시**
  ```text
  U: 2025-05-12 삼성전자, NAVER 변동성과 베타 알려줘
  A: 2025-05-12 기준 종목별 지표는 다음과 같습니다.
    - 삼성전자: 변동성 0.330, 베타 12.97
    - NAVER: 변동성 0.348, 베타 129.59

  U: 2025-06-17 KOSPI 변동성이 가장 높은 10개 종목은?
  A: 2025-06-17에 KOSPI에서 변동성이 높은 상위 10개 종목입니다.
    DH오토넥스, 대성산업, 참엔지니어링, KC코트렐, 평화홀딩스, 흥국화재우, 윌비스, 티와이홀딩스우, KG모빌리티, 쌍방울

  U: 최근 많이 오른 주식 알려줘
  A: 2025-07-29(최근 영업일) 기준 상승률 TOP 10은 다음과 같습니다.
    시디즈, 에코프로머티... (이하 생략)
  ```

