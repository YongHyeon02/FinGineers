# FinGineers – HyperCLOVA Fin Agent

## 1. 프로젝트 개요
HyperCLOVA API와 yfinance 실시간·과거 데이터를 결합하여 **금융 Q&A**를 수행하는 에이전트입니다.  
- **신뢰성 & 속도**: 실시간/배치 파이프라인 + 한국거래소 영업일 캘린더 적용  
- **모듈식 아키텍처**: 자연어 질문 → HCX-005 파라미터화 → Router → Task Handler

## 2. 팀 정보

| 구분   | 내용                    |
| ------ | ---------------------- |
| **팀명** | FinGineers            |
| **분야** | AI Tech |
| **팀원** | 조용현 · 박선홍       |

## 3. API 사용법


### 요청 형식

[HTTP Method & URL]
GET /agent?question=질문내용

URL: http://49.50.131.34:8000/agent

[필수 헤더]

- Authorization: Bearer API_KEY 
- X-NCP-CLOVASTUDIO-REQUEST-ID: 세션 ID 

  (선택. 없으면 서버가 자동 생성, 멀티턴 문답 시 세션 ID 필요)

### 요청 예시 (Python)

```python
import requests

API_KEY = "nv-xxx..."
SESSION_ID = "23ef..."  # 첫 요청(멀티턴 X)은 생략 가능

response = requests.get(
    "http://49.50.131.34:8000/agent",
    params={"question": "2025년 6월 11일에 삼성전자의 종가는?"},
    headers={
        "Authorization": f"Bearer {API_KEY}",
        "X-NCP-CLOVASTUDIO-REQUEST-ID": SESSION_ID  # 첫 요청(멀티턴 X)은 생략 가능
    }
)

print(response.json())
```

### 응답 형식

```json
{
  "answer": "2025-06-11 기준 종가는 71,300원입니다.",
  "session_id": "abc123..."
}
```
멀티턴 질문으로 다음 HTTP request 시 전 request에서 response로 받은 Session ID를 다음 request 헤더의   X-NCP-CLOVASTUDIO-REQUEST-ID에 넣어야 함

### 에러 응답 예시

- 400: 질문이 비어 있음
- 401: API 키 누락 또는 형식 오류


## 4. 핵심 특징

### 4-1. yfinance 데이터 캐싱
* `app/yf_cache.py`  
  * **프리패치**: `2024-01-01 ~ 2025-07-31` 구간은 Parquet 캐시만 사용 → 네트워크 호출 *0*  
  * 미캐시 구간은 즉시 호출 후 저장  
* `scripts/prefetch_yf.py` CLI로 대량 사전 수집 및 레이트-리밋 자동 처리

### 4-2. 영업일 계산 & 휴장일 메시지
* `pandas_market_calendars`의 `XKRX` 달력 사용  
* 비영업일 질의 시 `_holiday_msg()`가  
  `YYYY-MM-DD는 휴장일입니다. 데이터가 없습니다.` 반환

### 4-3. Ticker 디스앰비규에이션

| 단계 | 방법                     | 설명                                              |
| ---- | ------------------------ | ------------------------------------------------- |
| ①    | 정적 CSV                | KOSPI·KOSDAQ·Alias 매핑                           |
| ②    | **Fuzzy**               | `rapidfuzz` 편집거리 → 상위 `TOP_K_FUZZY = 3`         |
| ③    | **Sentence-BERT 임베딩**| 768-dim cosine sim → 상위 `TOP_K_EMBED = 3`           |
| ④    | **HCX Re-ranking**      | 후보를 HyperCLOVA가 최종 선택 (conf ≥ 0.82)       |

모호하면 `AmbiguousTickerError`를 발생시켜 **후속 재질문** 유도. Fuzzy와 Sentence-BERT 임베딩 상위 후보를 예시로 제시.

## 5. Task 별 구현

### 5-1. Task 1 — 단순 조회

| 기능(메서드)                         | 설명                                    |
|--------------------------------------|-----------------------------------------|
| `가격·등락률` `_answer_price()`       | 시가·종가·고가·저가·등락률 계산         |
| `거래량 Top N` `_answer_volume()`     | 특정 날짜·시장별 거래량 상위 N           |
| `상승/하락 종목 수` `_answer_updown_count()` | 하루 기준 상승·하락·보합 종목 개수      |
| `거래대금 합계` `_answer_trading_value()` | 시장별·날짜별 거래대금 총합             |
| `Top Mover/Price` `_answer_top_mover()` 등 | 등락률·가격 상위/하위 N                |
| **다중 Ticker/Metric**                | “삼성전자·카카오 종가·거래량” 같은 복합 질의 지원 |
| **Look-back 7일**                     | 매매정지·데이터 누락 시 `_LOOKBACK_DAYS = 7` 범위에서 대체 |
| **Volume 0 필터**                     | 거래량 0 종목은 모든 랭킹·통계에서 제외  |

---

### 5-2. Task 2 & Task 3 — 조건검색·시그널 감지

| 기능(메서드)                             | 설명                                                                 |
|------------------------------------------|----------------------------------------------------------------------|
| `종가 조건` `search_by_price_close()`     | 특정 날짜 기준 종가의 최소/최대 조건 필터링                         |
| `거래량 조건` `search_by_volume()`        | 특정 날짜 기준 거래량 최소/최대 조건 필터링                         |
| `등락률 조건` `search_by_pct_change()`    | 특정 날짜 기준 등락률(%) 최소/최대 조건 필터링                      |
| `전일대비 거래량 증가` `search_by_volume_pct()` | 거래량 전일 대비 증가율(%) 조건 필터링                              |
| `RSI 과매수/과매도` `detect_rsi()`        | 14일 RSI 기준 필터링    |
| `거래량 급증` `detect_volume_spike()`     | 과거 N일 평균 대비 급등한 종목 탐지 |
| `이동평균 돌파` `detect_ma_break()`         | 종가가 이동평균선에서 벗어난 종목 탐지 |
| `볼린저밴드 터치` `detect_bollinger_touch()` | 종가가 상단/하단 밴드에 접촉한 종목 탐지   |
| `기간 등락률 범위` `search_by_pct_change_range()` | 주어진 기간 동안 등락률 범위 내 종목 필터링                         |
| `연속 상승/하락` `search_by_consecutive_change()` | N일 연속 상승/하락한 종목 필터링                                   |
| `골든/데드크로스` `search_cross_dates_by_condition()` | 기간 중 단/장기 이평선의 골든/데드크로스 발생 종목 탐색            |
| `크로스 발생 횟수` `search_cross_count_by_stock()` | 특정 종목의 기간 내 크로스 발생 횟수 계산                          |

 #### **기본 설정값 적용**

  | 조건 유형          | 기본값                                      |
  |-------------------|---------------------------------------------|
  | RSI               | 기간: 14일, RSI 값 미설정 시 과매수=70, 과매도=30   |
  | 거래량 급증         | 기간: 20일             |
  | 이동평균 돌파       | 기간: 20일           |
  | 볼린저밴드 터치   | 기간: 20일, 편차: 2 |
---

- **다중 조건 AND 검색**  
  하나의 질문에 여러 조건이 포함될 경우, 해당 조건을 **모두 만족하는 종목만 반환**
  추가로 구현한 적/흑삼병, 신고/저가 등의 종목 질문도 다중 조건에 포함해서 질문 가능

- **거래량 0 제외**  
  거래량이 0인 종목은 **모든 조건 필터링 및 결과 출력에서 자동 제외**

- **기본 설정값 적용**

  | 조건 유형          | 기본값                                      |
  |-------------------|---------------------------------------------|
  | RSI               | 기간: 14일, 과매수=70, 과매도=30   |
  | 거래량 급증         | 기간: 20일             |
  | 이동평균 돌파       | 기간: 20일           |
  | 볼린저밴드 터치   | 기간: 20일, 편차: 2 |

- **대화 예시**
`U:`는 사용자(질문), `A:`는 Fin Agent(응답)입니다.
```text
U: 2025년 5월 30일에 등락률이 +10% 이상인 과매수 종목 알려줘  
A: 2025-05-30에 등락률이 10% 이상 상승인, RSI가 70 이상인 종목은 다음과 같습니다.  
   DH오토리드, DH오토웨어, ... (이하 생략)
```
---


---

### 5-3. Task 4 — 모호한 의미 해석

- “최근 많이 오른 주식 알려줘” 같은 추상 질의를 **HCX 프롬프트 예시**로 Task 1–3 JSON 구조로 재해석  
- **날짜 키워드 자동 보정**  
  - `오늘·금일·당일` → 질의 당일  
  - `최근·요즘` → 질의 당일 기준 가장 최근 영업일  
  - `YYYY` 생략 시 `2025년`으로 자동 매핑
  - 다양한 포맷 (`YYYY/MM/DD`, `YYYY년 MM월 DD일`) 지원  
- 필수 슬롯 누락 시 **후속 재질문을 한국어로 자연스럽게 생성**

- **대화 예시**
`U:`는 사용자(질문), `A:`는 Fin Agent(응답)입니다.
```text
U: 오늘 코스피 지수 알려줘 (질문일: 2025-07-29)
A: 2025-07-29에 KOSPI 지수는 3,230.57 입니다.
```
---

### 5-4. Task 5 — 고급 패턴·지표

| 카테고리               | 함수                         | 내용                                                          |
|------------------------|------------------------------|---------------------------------------------------------------|
| 캔들스틱 패턴          | `_scan_three_pattern()`      | 적삼병(Three White Soldiers), 흑삼병(Three Black Crows)       |
| 52주 신고가 돌파       | `detect_52w_high_break()`    | `period_days` 파라미터로 기간 가변                            |
| 52주 신저가            | `detect_52w_low()`           | —                                                             |
| 고점 대비 n % 하락     | `detect_off_peak()`          | 최고가 대비 하락률 필터                                       |
| 갭 상승·하락            | `search_by_gap_pct()`        | (Open_today − Close_prev) / Close_prev 기반                   |
| 급등·급락               | `search_by_pct_change()`     | 상·하한가, 근접, ±n % 등                                    |
| 변동률 (Volatility)     | `calculate_volatility()`     | 지정 기간(예: 20일) 동안 수익률의 표준편차(롤링 변동성) 계산  |
| 베타 (Beta)            | `calculate_beta()`           | 종목과 벤치마크(예: KOSPI) 간 상관계수로 산출된 베타 계수 계산 |

- **대화 예시**
`U:`는 사용자(질문), `A:`는 Fin Agent(응답)입니다.

```text
U: 2025-05-12 삼성전자, NAVER 변동성과 베타 알려줘
A: 2025-05-12 기준 종목별 지표는 다음과 같습니다.
   - 삼성전자: 변동성 0.330, 베타 12.97
   - NAVER: 변동성 0.348, 베타 129.59

U: 2025-06-17 KOSPI 변동성이 가장 높은 10개 종목은?
A: 2025-06-17에 KOSPI에서 변동성이 높은 상위 10개 종목입니다.
   DH오토넥스, 대성산업, 참엔지니어링, KC코트렐, 평화홀딩스, 흥국화재우, 윌비스, 티와이홀딩스우, KG모빌리티, 쌍방울

U: 최근 많이 오른 주식 알려줘
A: 2025-07-29(최근 영업일) 기준 상승률 TOP 10은 다음과 같습니다.
   시디즈, 에코프로머티... (이하 생략)
```

