# FinGineers – HyperCLOVA Fin Agent (한국어 설명서)
[English README](./README.md)

자연어(한국어) 질문을 받아 **금융 Q\&A**를 수행하는 에이전트입니다.
HyperCLOVA(HCX)로 **파라미터 추출·재질문**을 처리하고, **yfinance + Parquet 캐시**로 **속도/안정성**을 확보했습니다.
대상: **코스피/코스닥(스팩·리츠 제외)**

---

## 빠른 시작

### 서버 실행

```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

**엔드포인트**

```
GET http://localhost:8000/agent?question=<한국어 질문>
```

**필수 헤더**

* `Authorization: Bearer <YOUR_HYPERCLOVA_API_KEY>`
* `X-NCP-CLOVASTUDIO-REQUEST-ID: <세션 ID>` (싱글턴은 생략 가능, 멀티턴은 유지 필수)

### 요청 예시 (Python)

```python
import requests

API_KEY = "nv-xxx..."
SESSION_ID = "23ef..."   # 첫 요청(멀티턴 X)은 생략 가능

response = requests.get(
    "http://localhost:8000/agent",
    params={"question": "2025-06-17 삼성전자 종가는?"},
    headers={
        "Authorization": f"Bearer {API_KEY}",
        "X-NCP-CLOVASTUDIO-REQUEST-ID": SESSION_ID
    }
)
print(response.json())
```

**응답 예시**

```json
{
  "answer": "2025-06-17에 삼성전자의 종가은(는) 58,100원 입니다.",
  "session_id": "23ef..."
}
```

> 멀티턴: 후속 질문/답변에서는 **동일한 세션 ID**를 `X-NCP-...` 헤더로 보내세요.

---

## 주요 기능

* **LLM 기반 슬롯 채우기**: 날짜/종목/지표가 누락되면 한국어로 자연스러운 **재질문**을 생성
* **속도/안정성**:

  * 큰 구간을 **사전 프리패치 → 로컬 Parquet 캐시**
  * 캐시 외 구간은 yfinance 호출 후 곧바로 캐시에 병합 저장
  * 한국거래소 **영업일 캘린더** 적용(휴장일엔 안내 메시지)
* **티커 인식 개선**: Fuzzy + SBERT 임베딩 + HCX 재랭킹 → 모호하면 상위 후보 제안과 함께 **재질문**
* **지원 태스크**

  * 단순 조회(시가/종가/고가/저가/등락률/거래량/지수/거래대금)
  * 시장 카운트(상승/하락/거래 종목 수)
  * 랭킹(거래량/상승률/하락률/가격/변동성/베타)
  * 조건 검색(RSI, 거래량 급증, 이동평균 돌파, 볼린저 밴드 터치, 갭, 52주 신고가/신저가, 고점 대비 하락 등)
  * 패턴·크로스(적삼병/흑삼병, 골든/데드 크로스 횟수/발생일)

---

## 예시

```text
U: 삼성전자 종가는?
A: 어떤 날짜의 삼성전자 종가를 알려 드릴까요?
U: 2025-07-07
A: 2025-07-07에 삼성전자의 종가은(는) 61,700원 입니다.
```

```text
U: 2025-06-17 삼성전자, 카카오, 네이버의 종가·거래량·등락률·변동성·베타는?
A: 2025-06-17 기준 종목별 지표는 다음과 같습니다.
  - 삼성전자: 종가 58,100원, 거래량 28,637,003주, 등락률 +1.57%, 변동성 0.320, 베타 7.67
  - 카카오: 종가 51,800원, 거래량 3,981,660주, 등락률 -2.63%, 변동성 0.551, 베타 22.30
  - 네이버: 종가 206,500원, 거래량 837,169주, 등락률 -1.43%, 변동성 0.317, 베타 26.87
```

```text
U: 2025-06-30에 시가가 전일 종가 대비 5% 이상 갭상승한 종목 알려줘
A: 2025-06-30에 갭상승 5% 이상 종목은 다음과 같습니다.
  SCL사이언스, SK이노베이션, ... (생략)
```

---

## 시스템 개요

```
자연어(한국어)
   │
   ▼
Router ──► HyperCLOVA(HCX)  → 파라미터 추출/후속질문
   │
   ├─ 단순조회(가격/거래량/지수/거래대금)
   ├─ 조건검색·시그널(RSI/MA/볼린저/갭/52주…)
   ├─ 모호문 처리(추상 질의 → 명시 질의)
   └─ 고급 패턴(적/흑삼병)·크로스(골든/데드)
         │
         └─ Data Fetcher → yfinance(+Parquet 캐시) → 영업일 체크
```

**구성요소**

* `main.py`: FastAPI `/agent` 엔드포인트 & 세션 헤더 처리
* `app/router.py`: 질문 라우팅 및 재질문 로직
* `app/task_handlers/`: 단순 조회, 랭킹, 검색/패턴 등 태스크 처리
* `app/search_utils.py`: RSI, 거래량 급증, 이평 돌파, 볼린저, 갭, 52주, off‑peak, 크로스, 적/흑삼병
* `app/data_fetcher.py`, `app/yf_cache.py`: yfinance 연동 & Parquet 캐시
* `app/ticker_lookup.py`: 종목명/별칭 → 티커 매핑 및 디스앰비규에이션
* `hcx_system_prompt.txt`, `follow_prompt.json`: HCX 파라미터 추출 프롬프트

---

## 참고/제한

* 현재 버전은 **한국어 응답**에 최적화되어 있습니다(국제화는 프롬프트/문구 교체로 확장 가능).
* yfinance 특성상 데이터 커버리지/지연이 일부 종목에 존재할 수 있습니다.